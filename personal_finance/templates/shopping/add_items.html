{% extends "base.html" %}

{% block title %}
{{ t('shopping_title', default='Shopping List Manager') | e }}
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/shopping.css') | e }}">
{% endblock %}

{% block content %}
<div class="container">
    {% set tool_name = 'shopping_title' %}
    {% set tool_icon = 'fa-cart-shopping' %}
    {% set subtitle = t('shopping_subtitle', default='Organize and manage your shopping lists efficiently') | e %}
    {% include 'tool_header.html' %}

    <div class="toast-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% for category, message in messages %}
                <div class="toast align-items-center text-white bg-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' }} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            {{ t(message, default=message) | e }}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="{{ t('general_close', default='Close') | e }}"></button>
                    </div>
                </div>
            {% endfor %}
        {% endwith %}
    </div>

    <div class="modal fade" id="budgetWarningModal" tabindex="-1" aria-labelledby="budgetWarningModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="budgetWarningModalLabel">{{ t('shopping_budget_warning', default='Budget Exceeded') | e }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') | e }}"></button>
                </div>
                <div class="modal-body">
                    {{ t('shopping_budget_exceeded', default='Your total spending exceeds the budget. Please review your items.') | e }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_close', default='Close') | e }}</button>
                    <button type="button" class="btn btn-primary" id="proceedSubmit">{{ t('shopping_proceed_anyway', default='Proceed Anyway') | e }}</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade edit-modal" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">{{ t('shopping_edit_item', default='Edit Item') | e }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('general_close', default='Close') | e }}"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-item-id">
                    <div class="mb-3">
                        <label for="edit-item-name" class="form-label">{{ t('general_item_name', default='Item Name') | e }}</label>
                        <input type="text" id="edit-item-name" class="form-control" required>
                        <div class="invalid-feedback">{{ t('shopping_item_name_invalid', default='Please enter a valid item name') | e }}</div>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-quantity" class="form-label">{{ t('general_quantity', default='Quantity') | e }}</label>
                        <input type="number" id="edit-item-quantity" class="form-control number-input" min="1" max="1000" required>
                        <small class="form-text text-muted">{{ t('shopping_quantity_help', default='Enter the number of units (e.g., 2 cartons, 5 pieces)') | e }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-price" class="form-label">{{ t('general_price', default='Price') | e }}</label>
                        <input type="text" id="edit-item-price" class="form-control number-input" data-allow-commas="true" required>
                        <small class="form-text text-muted">{{ t('shopping_price_help', default='Enter price per unit (e.g., price for one carton or piece)') | e }}</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-unit" class="form-label">{{ t('general_unit', default='Unit') | e }}</label>
                        <select id="edit-item-unit" class="form-control">
                            {% for value, label in item_form.unit.choices %}
                                <option value="{{ value | e }}">{{ t(value, default=label) | e }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-category" class="form-label">{{ t('general_category', default='Category') | e }}</label>
                        <select id="edit-item-category" class="form-control">
                            {% for value, label in item_form.category.choices %}
                                <option value="{{ value | e }}">{{ t(value, default=label) | e }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-status" class="form-label">{{ t('general_status', default='Status') | e }}</label>
                        <select id="edit-item-status" class="form-control">
                            {% for value, label in item_form.status.choices %}
                                <option value="{{ value | e }}">{{ t(value, default=label) | e }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-store" class="form-label">{{ t('general_store', default='Store') | e }}</label>
                        <input type="text" id="edit-item-store" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="edit-item-frequency" class="form-label">{{ t('general_frequency', default='Frequency') | e }}</label>
                        <input type="number" id="edit-item-frequency" class="form-control number-input" min="1" max="365">
                        <small class="form-text text-muted">{{ t('shopping_frequency_help', default='Enter frequency in days (e.g., 7)') | e }}</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t('general_cancel', default='Cancel') | e }}</button>
                    <button type="button" class="btn btn-primary" id="saveEditItem">{{ t('shopping_save_changes', default='Save Changes') | e }}</button>
                </div>
            </div>
        </div>
    </div>

    <div id="duplicateWarning" class="alert alert-warning alert-dismissible fade d-none" role="alert">
        {{ t('shopping_duplicate_item', default='Duplicate item name detected. Please use unique item names.') | e }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="{{ t('general_close', default='Close') | e }}"></button>
    </div>

    <ul class="nav nav-tabs mb-4" id="shoppingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('shopping.main', tab='create-list') | e }}">
                <i class="fa-solid fa-plus"></i> {{ t('shopping_create_list', default='Create List') | e }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link active" href="{{ url_for('shopping.main', tab='add-items') | e }}">
                <i class="fa-solid fa-cart-plus"></i> {{ t('shopping_add_items', default='Add Items') | e }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('shopping.main', tab='view-lists') | e }}">
                <i class="fa-solid fa-list"></i> {{ t('shopping_view_lists', default='View Lists') | e }}
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="{{ url_for('shopping.main', tab='manage-list') | e }}">
                <i class="fa-solid fa-list-check"></i> {{ t('shopping_manage_list', default='Manage List') | e }}
            </a>
        </li>
    </ul>

    <div class="tab-content" id="shoppingTabContent">
        <div class="tab-pane fade show active" id="add-items" role="tabpanel" aria-labelledby="add-items-tab">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fa-solid fa-cart-plus"></i> {{ t('shopping_add_items', default='Add Items to List') | e }}</h5>
                </div>
                <div class="card-body">
                    {% if lists %}
                        <div class="mb-3">
                            <label for="dashboard-list-select" class="form-label">{{ t('shopping_select_list', default='Select a Shopping List') | e }}</label>
                            <select id="dashboard-list-select" class="form-select">
                                <option value="">{{ t('general_select', default='Select a list') | e }}</option>
                                {% for list_id, lst in lists.items() %}
                                    {% if lst.status != 'saved' %}
                                        <option value="{{ lst.id | e }}" {{ 'selected' if selected_list_id == lst.id else '' }}>{{ lst.name | e }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div id="dashboard-content">
                            {% if selected_list and selected_list.id and selected_list.status != 'saved' %}
                                <form id="saveListForm" method="POST" action="{{ url_for('shopping.main', tab='add-items') | e }}" class="validate-form">
                                    {{ list_form.csrf_token }}
                                    <input type="hidden" name="action" value="save_list">
                                    <input type="hidden" name="list_id" value="{{ selected_list.id | e }}">
                                    <input type="hidden" name="budget" id="list_budget" class="number-input" data-allow-commas="true" value="{{ selected_list.budget_raw | e }}">
                                    <p><strong>{{ t('general_budget', default='Budget') | e }}:</strong> <span id="budget-amount">{{ selected_list.budget_raw | format_currency | e }}</span></p>
                                    <p><strong>{{ t('general_total_spent', default='Total Spent') | e }}:</strong> <span id="total-spent">{{ selected_list.total_spent_raw | format_currency | e }}</span></p>
                                    <p><strong>{{ t('general_remaining', default='Remaining') | e }}:</strong> <span id="remaining-budget">{{ (selected_list.budget_raw - selected_list.total_spent_raw) | format_currency | e }}</span></p>
                                    <div class="progress">
                                        <div class="progress-bar" role="progressbar" style="width: {{ (selected_list.total_spent_raw / selected_list.budget_raw * 100) if selected_list.budget_raw > 0 else 0 }}%" id="budget-progress" aria-valuenow="{{ (selected_list.total_spent_raw / selected_list.budget_raw * 100) if selected_list.budget_raw > 0 else 0 }}" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6><i class="fa-solid fa-cart-plus"></i> {{ t('shopping_add_item', default='Add Item to List') | e }}</h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="addItemForm" class="validate-form">
                                                <input type="hidden" name="list_id" value="{{ selected_list.id | e }}">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_name" class="form-label">{{ t('general_item_name', default='Item Name') | e }}</label>
                                                        <input type="text" id="item_name" class="form-control" placeholder="{{ t('shopping_item_name_placeholder', default='e.g., Milk') | e }}" required>
                                                        <div class="invalid-feedback">{{ t('shopping_item_name_invalid', default='Please enter a valid item name') | e }}</div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_quantity" class="form-label">{{ t('general_quantity', default='Quantity') | e }}</label>
                                                        <input type="number" id="item_quantity" class="form-control number-input" placeholder="{{ t('shopping_quantity_placeholder', default='e.g., 2') | e }}" min="1" max="1000" value="1" required>
                                                        <small class="form-text text-muted">{{ t('shopping_quantity_help', default='Enter the number of units (e.g., 2 cartons, 5 pieces)') | e }}</small>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_price" class="form-label">{{ t('general_price', default='Price') | e }}</label>
                                                        <input type="text" id="item_price" class="form-control number-input" data-allow-commas="true" placeholder="{{ t('shopping_price_placeholder', default='e.g., 500.00') | e }}" value="0.00" required>
                                                        <small class="form-text text-muted">{{ t('shopping_price_help', default='Enter price per unit (e.g., price for one carton or piece)') | e }}</small>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_unit" class="form-label">{{ t('general_unit', default='Unit') | e }}</label>
                                                        <select id="item_unit" class="form-control" required>
                                                            {% for value, label in item_form.unit.choices %}
                                                                <option value="{{ value | e }}">{{ t(value, default=label) | e }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_store" class="form-label">{{ t('general_store', default='Store') | e }}</label>
                                                        <input type="text" id="item_store" class="form-control" placeholder="{{ t('shopping_store_placeholder', default='e.g., Shoprite') | e }}">
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_category" class="form-label">{{ t('general_category', default='Category') | e }}</label>
                                                        <select id="item_category" class="form-control" required>
                                                            {% for value, label in item_form.category.choices %}
                                                                <option value="{{ value | e }}">{{ t(value, default=label) | e }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_status" class="form-label">{{ t('general_status', default='Status') | e }}</label>
                                                        <select id="item_status" class="form-control" required>
                                                            {% for value, label in item_form.status.choices %}
                                                                <option value="{{ value | e }}">{{ t(value, default=label) | e }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="item_frequency" class="form-label">{{ t('general_frequency', default='Frequency') | e }}</label>
                                                        <input type="number" id="item_frequency" class="form-control number-input" placeholder="{{ t('shopping_frequency_placeholder', default='e.g., 7') | e }}" min="1" max="365" value="7">
                                                        <small class="form-text text-muted">{{ t('shopping_frequency_help', default='Enter frequency in days (e.g., 7)') | e }}</small>
                                                    </div>
                                                </div>
                                                <button type="button" class="btn btn-primary" id="addItemSubmit">
                                                    <i class="fa-solid fa-cart-plus"></i> {{ t('shopping_add_item', default='Add Item') | e }}
                                                </button>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="card mb-4">
                                        <div class="card-header">
                                            <h6><i class="fa-solid fa-list"></i> {{ t('shopping_items', default='Items') | e }}</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-striped" id="items-table">
                                                    <thead>
                                                        <tr>
                                                            <th>{{ t('general_item_name', default='Item Name') | e }}</th>
                                                            <th>{{ t('general_quantity', default='Quantity') | e }}</th>
                                                            <th>{{ t('general_price', default='Price') | e }}</th>
                                                            <th>{{ t('general_unit', default='Unit') | e }}</th>
                                                            <th>{{ t('general_category', default='Category') | e }}</th>
                                                            <th>{{ t('general_status', default='Status') | e }}</th>
                                                            <th>{{ t('general_store', default='Store') | e }}</th>
                                                            <th>{{ t('general_frequency', default='Frequency') | e }}</th>
                                                            <th>{{ t('general_actions', default='Actions') | e }}</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="items-table-body">
                                                        {% if selected_list.items %}
                                                            {% for item in selected_list.items %}
                                                                <tr data-item-id="{{ item.id | e }}">
                                                                    <td>{{ item.name | e }}</td>
                                                                    <td>{{ item.quantity | e }}</td>
                                                                    <td>{{ item.price | format_currency | e }}</td>
                                                                    <td>{{ t(item.unit, default=item.unit) | e }}</td>
                                                                    <td>{{ t(item.category, default=item.category) | e }}</td>
                                                                    <td>{{ t(item.status, default=item.status) | e }}</td>
                                                                    <td>{{ item.store | e }}</td>
                                                                    <td>{{ item.frequency | e }}</td>
                                                                    <td>
                                                                        <button type="button" class="btn btn-sm btn-info edit-item" data-id="{{ item.id | e }}" data-bs-toggle="modal" data-bs-target="#editItemModal">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-danger delete-item" data-id="{{ item.id | e }}">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </td>
                                                                </tr>
                                                            {% endfor %}
                                                        {% endif %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="mt-3">
                                                <button type="submit" class="btn btn-primary" id="saveListSubmit">
                                                    <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                                                    <i class="fa-solid fa-floppy-disk"></i> {{ t('shopping_save_list', default='Save List') | e }}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            {% else %}
                                <div class="empty-state text-center">
                                    <i class="fas fa-cart-shopping fa-3x mb-3"></i>
                                    <p>{{ t('shopping_no_list_selected', default='No active list selected. Please select an active list to add items.') | e }}</p>
                                    <a href="{{ url_for('shopping.main', tab='create-list') | e }}" class="btn btn-primary">
                                        <i class="fa-solid fa-plus"></i> {{ t('shopping_create_list', default='Create List') | e }}
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center">
                            <i class="fas fa-cart-shopping fa-3x mb-3"></i>
                            <p>{{ t('shopping_no_lists', default='No active lists found. Create one to get started.') | e }}</p>
                            <a href="{{ url_for('shopping.main', tab='create-list') | e }}" class="btn btn-primary">
                                <i class="fa-solid fa-plus"></i> {{ t('shopping_create_list', default='Create List') | e }}
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Injected JavaScript for dynamic functionality
    document.addEventListener('DOMContentLoaded', function() {
        const url_for_get_list_details = "{{ url_for('shopping.get_list_details') | e }}";
        const csrf_token = "{{ csrf_token() | e }}";

        // Toast Initialization
        document.querySelectorAll('.toast').forEach(toast => {
            new bootstrap.Toast(toast).show();
        });

        // Function to handle fetching and displaying list details
        function loadListDetails(listId) {
            if (!listId) {
                document.getElementById('dashboard-content').innerHTML = `
                    <div class="empty-state text-center">
                        <i class="fas fa-cart-shopping fa-3x mb-3"></i>
                        <p>{{ t('shopping_no_list_selected', default='No active list selected. Please select an active list to add items.') | e }}</p>
                        <a href="{{ url_for('shopping.main', tab='create-list') | e }}" class="btn btn-primary">
                            <i class="fa-solid fa-plus"></i> {{ t('shopping_create_list', default='Create List') | e }}
                        </a>
                    </div>
                `;
                return;
            }
            
            fetch(url_for_get_list_details, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf_token
                },
                body: JSON.stringify({ 'list_id': listId })
            })
            .then(response => response.json())
            .then(data => {
                const list = data.list;
                if (list) {
                    // Update budget and totals
                    document.getElementById('budget-amount').textContent = list.budget_formatted;
                    document.getElementById('total-spent').textContent = list.total_spent_formatted;
                    document.getElementById('remaining-budget').textContent = (list.budget_raw - list.total_spent_raw).toFixed(2);
                    
                    const progressBar = document.getElementById('budget-progress');
                    const progressValue = list.budget_raw > 0 ? (list.total_spent_raw / list.budget_raw) * 100 : 0;
                    progressBar.style.width = progressValue + '%';
                    
                    // Populate items table
                    const tableBody = document.getElementById('items-table-body');
                    tableBody.innerHTML = '';
                    list.items.forEach(item => {
                        const row = `
                            <tr data-item-id="${item.id}">
                                <td>${item.name}</td>
                                <td>${item.quantity}</td>
                                <td>${item.price_formatted}</td>
                                <td>${item.unit}</td>
                                <td>${item.category}</td>
                                <td>${item.status}</td>
                                <td>${item.store}</td>
                                <td>${item.frequency}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-info edit-item" data-id="${item.id}" data-bs-toggle="modal" data-bs-target="#editItemModal"><i class="fas fa-edit"></i></button>
                                    <button type="button" class="btn btn-sm btn-danger delete-item" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                }
            })
            .catch(error => console.error('Error loading list details:', error));
        }

        // Handle list selection change
        const listSelect = document.getElementById('dashboard-list-select');
        if (listSelect) {
            listSelect.addEventListener('change', (event) => {
                loadListDetails(event.target.value);
            });
            // Initial load if a list is pre-selected
            if (listSelect.value) {
                loadListDetails(listSelect.value);
            }
        }
        
        // Handle adding a new item
        const addItemForm = document.getElementById('addItemForm');
        if (addItemForm) {
            addItemForm.addEventListener('submit', function(event) {
                event.preventDefault();
                if (!this.checkValidity()) {
                    this.classList.add('was-validated');
                    return;
                }
                
                const formData = new FormData(this);
                const listId = formData.get('list_id');
                const itemName = document.getElementById('item_name').value;
                const itemQuantity = document.getElementById('item_quantity').value;
                const itemPrice = document.getElementById('item_price').value.replace(/,/g, '');
                const itemUnit = document.getElementById('item_unit').value;
                const itemCategory = document.getElementById('item_category').value;
                const itemStatus = document.getElementById('item_status').value;
                const itemStore = document.getElementById('item_store').value;
                const itemFrequency = document.getElementById('item_frequency').value;
                
                const payload = {
                    action: 'add_item',
                    list_id: listId,
                    name: itemName,
                    quantity: itemQuantity,
                    price: itemPrice,
                    unit: itemUnit,
                    category: itemCategory,
                    status: itemStatus,
                    store: itemStore,
                    frequency: itemFrequency,
                    csrf_token: csrf_token
                };
                
                fetch(this.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf_token },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadListDetails(listId);
                        this.reset();
                        this.classList.remove('was-validated');
                    } else {
                        // Handle errors, e.g., duplicate item warning
                        if (data.message === 'Duplicate item') {
                            const warning = document.getElementById('duplicateWarning');
                            warning.classList.remove('d-none');
                            warning.classList.add('show');
                        }
                    }
                })
                .catch(error => console.error('Error adding item:', error));
            });
        }
        
        // Handle saving list
        const saveListForm = document.getElementById('saveListForm');
        if (saveListForm) {
            saveListForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const submitButton = document.getElementById('saveListSubmit');
                const spinner = submitButton.querySelector('.spinner-border');
                
                const totalSpent = parseFloat(document.getElementById('total-spent').textContent.replace(/[^0-9.-]+/g, ""));
                const budget = parseFloat(document.getElementById('list_budget').value.replace(/,/g, ''));
                
                if (totalSpent > budget) {
                    const budgetWarningModal = new bootstrap.Modal(document.getElementById('budgetWarningModal'));
                    budgetWarningModal.show();
                    
                    document.getElementById('proceedSubmit').addEventListener('click', () => {
                        this.submit();
                    });
                } else {
                    submitButton.disabled = true;
                    spinner.classList.remove('d-none');
                    this.submit();
                }
            });
        }

        // Handle edit item modal
        const editItemModal = document.getElementById('editItemModal');
        if (editItemModal) {
            editItemModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const itemId = button.getAttribute('data-id');
                const row = document.querySelector(`[data-item-id="${itemId}"]`);
                
                document.getElementById('edit-item-id').value = itemId;
                document.getElementById('edit-item-name').value = row.cells[0].textContent;
                document.getElementById('edit-item-quantity').value = row.cells[1].textContent;
                document.getElementById('edit-item-price').value = row.cells[2].textContent.replace(/[^0-9.]/g, '');
                document.getElementById('edit-item-unit').value = row.cells[3].textContent;
                document.getElementById('edit-item-category').value = row.cells[4].textContent;
                document.getElementById('edit-item-status').value = row.cells[5].textContent;
                document.getElementById('edit-item-store').value = row.cells[6].textContent;
                document.getElementById('edit-item-frequency').value = row.cells[7].textContent;
            });
            
            document.getElementById('saveEditItem').addEventListener('click', () => {
                const itemId = document.getElementById('edit-item-id').value;
                const listId = document.querySelector('#addItemForm input[name="list_id"]').value;
                const newName = document.getElementById('edit-item-name').value;
                const newQuantity = document.getElementById('edit-item-quantity').value;
                const newPrice = document.getElementById('edit-item-price').value.replace(/,/g, '');
                const newUnit = document.getElementById('edit-item-unit').value;
                const newCategory = document.getElementById('edit-item-category').value;
                const newStatus = document.getElementById('edit-item-status').value;
                const newStore = document.getElementById('edit-item-store').value;
                const newFrequency = document.getElementById('edit-item-frequency').value;
                
                const payload = {
                    action: 'edit_item',
                    list_id: listId,
                    item_id: itemId,
                    name: newName,
                    quantity: newQuantity,
                    price: newPrice,
                    unit: newUnit,
                    category: newCategory,
                    status: newStatus,
                    store: newStore,
                    frequency: newFrequency,
                    csrf_token: csrf_token
                };

                fetch(saveListForm.action, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf_token },
                    body: JSON.stringify(payload)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadListDetails(listId);
                        const modal = bootstrap.Modal.getInstance(editItemModal);
                        modal.hide();
                    } else {
                        // Handle errors
                        console.error('Error saving item changes:', data.message);
                    }
                })
                .catch(error => console.error('Error saving item changes:', error));
            });
        }
        
        // Handle deleting an item
        document.addEventListener('click', function(event) {
            if (event.target.closest('.delete-item')) {
                const button = event.target.closest('.delete-item');
                const itemId = button.getAttribute('data-id');
                const listId = document.querySelector('#addItemForm input[name="list_id"]').value;
                
                if (confirm('Are you sure you want to delete this item?')) {
                    const payload = {
                        action: 'delete_item',
                        list_id: listId,
                        item_id: itemId,
                        csrf_token: csrf_token
                    };
                    
                    fetch(saveListForm.action, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf_token },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadListDetails(listId);
                        } else {
                            console.error('Error deleting item:', data.message);
                        }
                    })
                    .catch(error => console.error('Error deleting item:', error));
                }
            }
        });
    });
</script>
{% endblock %}
